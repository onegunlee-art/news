name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  PHP_VERSION: '8.4'

jobs:
  # ========================================
  # Î∞±ÏóîÎìú ÌÖåÏä§Ìä∏
  # ========================================
  test-backend:
    name: Test Backend (PHP)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo, pdo_mysql, curl, json, mbstring
          coverage: none

      - name: Validate PHP syntax
        run: |
          find src/backend -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"
          if [ $? -eq 0 ]; then exit 0; else exit 1; fi

      - name: Check PHP files
        run: |
          echo "PHP files validated successfully"

  # ========================================
  # ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú
  # ========================================
  build-frontend:
    name: Build Frontend (React)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Type check
        working-directory: src/frontend
        run: npm run build
        continue-on-error: true

      - name: Build for production
        working-directory: src/frontend
        run: npm run build
        env:
          VITE_API_URL: /api

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/
          retention-days: 7

  # ========================================
  # FTP Î∞∞Ìè¨ (dothome)
  # ========================================
  deploy:
    name: Deploy to dothome
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/

      - name: Create deployment package
        run: |
          # Î∞∞Ìè¨Ïóê ÌïÑÏöîÌïú ÌååÏùºÎì§Îßå ÏÑ†ÌÉù
          mkdir -p deploy
          
          # Public Ìè¥Îçî (ÌîÑÎ°†Ìä∏ÏóîÎìú ÎπåÎìú + PHP ÏßÑÏûÖÏ†ê)
          cp -r public/* deploy/
          
          # Config Ìè¥Îçî
          mkdir -p deploy/config
          cp config/*.php deploy/config/ 2>/dev/null || true
          
          # Backend ÏÜåÏä§
          mkdir -p deploy/src/backend
          cp -r src/backend/* deploy/src/backend/
          
          # Database Ïä§ÌÇ§Îßà
          mkdir -p deploy/database
          cp database/schema.sql deploy/database/
          
          # Î∂àÌïÑÏöîÌïú ÌååÏùº Ï†úÍ±∞
          find deploy -name "*.md" -delete 2>/dev/null || true
          find deploy -name "*.txt" -delete 2>/dev/null || true
          find deploy -name ".git*" -delete 2>/dev/null || true

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env*
            **/README.md

      - name: Deployment notification
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Site URL: http://ailand.dothome.co.kr"

  # ========================================
  # Î∞∞Ìè¨ ÌõÑ Í≤ÄÏ¶ù
  # ========================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://ailand.dothome.co.kr/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ö†Ô∏è Health check returned: $response"
          fi

      - name: Check homepage
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://ailand.dothome.co.kr/)
          if [ "$response" = "200" ]; then
            echo "‚úÖ Homepage accessible"
          else
            echo "‚ö†Ô∏è Homepage returned: $response"
          fi
