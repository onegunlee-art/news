name: Build and Deploy
# ë°°í¬ëŠ” main ë¸Œëœì¹˜ì— pushí•  ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë˜ë ¤ë©´ ë°˜ë“œì‹œ mainì— pushí•˜ì„¸ìš”.

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  PHP_VERSION: '8.4'

jobs:
  # ========================================
  # ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
  # ========================================
  test-backend:
    name: Test Backend (PHP)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo, pdo_mysql, curl, json, mbstring
          coverage: none

      - name: Validate PHP syntax
        run: |
          echo "Validating PHP syntax..."
          failed=0
          for file in $(find src/backend src/agents -name "*.php" 2>/dev/null); do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "âŒ Syntax error in: $file"
              php -l "$file"
              failed=1
            else
              echo "âœ… $file"
            fi
          done
          if [ $failed -eq 1 ]; then
            echo "PHP syntax validation failed"
            exit 1
          fi
          echo "All PHP files validated successfully"

      - name: Check PHP files
        run: |
          echo "PHP files validated successfully"

  # ========================================
  # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
  # ========================================
  build-frontend:
    name: Build Frontend (React)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: src/frontend/package-lock.json

      - name: Install dependencies
        working-directory: src/frontend
        run: npm ci

      - name: Type check
        working-directory: src/frontend
        run: npm run build
        continue-on-error: true

      - name: Build for production
        working-directory: src/frontend
        run: npm run build
        env:
          VITE_API_URL: /api

      - name: List built files (ë°°í¬ë  í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ í™•ì¸)
        run: |
          echo "=== public/ ë‚´ìš© (ë°°í¬ ëŒ€ìƒ) ==="
          ls -la public/
          ls -la public/assets/ 2>/dev/null || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: public/
          retention-days: 7

  # ========================================
  # FTP ë°°í¬ (dothome)
  # ========================================
  deploy:
    name: Deploy to dothome
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: public/

      - name: Verify deploy package
        run: |
          echo "=== ë°°í¬ íŒ¨í‚¤ì§€ì— í¬í•¨ë  í•­ëª© ==="
          ls -la public/
          test -f public/index.html && echo "OK: index.html ìˆìŒ" || echo "WARN: index.html ì—†ìŒ"
          ls public/assets/ 2>/dev/null | head -5 || true

      - name: Create deployment package
        run: |
          # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ë§Œ ì„ íƒ
          mkdir -p deploy
          
          # Public í´ë” (í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ + PHP ì§„ì…ì )
          cp -r public/* deploy/
          
          # Config í´ë”
          mkdir -p deploy/config
          cp config/*.php deploy/config/ 2>/dev/null || true
          
          # Backend ì†ŒìŠ¤
          mkdir -p deploy/src/backend
          cp -r src/backend/* deploy/src/backend/
          
          # Agents ì†ŒìŠ¤ (AI ë¶„ì„ ì‹œìŠ¤í…œ)
          mkdir -p deploy/src/agents
          cp -r src/agents/* deploy/src/agents/
          
          # Storage í´ë” (í•™ìŠµ ë°ì´í„°ìš©)
          mkdir -p deploy/storage/learning
          mkdir -p deploy/storage/audio
          
          # Database ìŠ¤í‚¤ë§ˆ
          mkdir -p deploy/database
          cp database/schema.sql deploy/database/
          
          # ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
          find deploy -name "*.md" -delete 2>/dev/null || true
          find deploy -name "*.txt" -delete 2>/dev/null || true
          find deploy -name ".git*" -delete 2>/dev/null || true

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /html/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env*
            **/README.md

      - name: Deployment notification
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site URL: https://www.thegist.co.kr"

  # ========================================
  # ë°°í¬ í›„ ê²€ì¦ (ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨)
  # ========================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      SITE_URL: https://www.thegist.co.kr

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.SITE_URL }}/api/health" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check returned: $response (expected 200)"
            exit 1
          fi

      - name: Check homepage
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.SITE_URL }}/" || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Homepage accessible"
          else
            echo "âŒ Homepage returned: $response (expected 200)"
            exit 1
          fi
